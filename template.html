
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FPL Fixture Planner</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --fpl-white: #ffffff;
      --fpl-light-gray: #f8f9fa;
      --fpl-gray: #e9ecef;
      --fpl-dark-gray: #6c757d;
      --fpl-text: #212529;
      --fpl-text-light: #6c757d;
      --fpl-border: #dee2e6;
      --fpl-primary: #37003c;
      --fpl-primary-light: #4a0052;
      --fpl-success: #28a745;
      --fpl-danger: #dc3545;
      --fpl-bg: #fafafa;
      --fdr-1: #28a745;
      --fdr-2: #00ff85;
      --fdr-3: #e9ecef;
      --fdr-4: #dc3545;
      --fdr-5: #37003c;
      --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      --border-radius: 6px;
      --border-radius-pill: 50px;
      --border-radius-fdr: 8px;
      --transition: all 0.2s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--fpl-bg);
      color: var(--fpl-text);
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .welcome-header {
      width: 100%;
      margin-bottom: 30px;
      text-align: center;
      background: #f5f5f5;
      padding: 40px 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
    }

    .welcome-text {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 2.5rem;
      font-weight: 700;
      color: #444444;
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
    }

    .header-logo {
      height: 60px;
      width: auto;
      object-fit: contain;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px 0;
    }

    .header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
      color: var(--fpl-text);
    }

    .header p {
      font-size: 1.1rem;
      color: var(--fpl-text-light);
      font-weight: 400;
    }

    .controls-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .controls-section {
      background: var(--fpl-white);
      border: 1px solid var(--fpl-border);
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: var(--shadow);
    }

    .controls-section h3 {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--fpl-text);
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--fpl-primary);
    }

    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      align-items: end;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .control-group label {
      font-weight: 700;
      font-size: 0.875rem;
      color: var(--fpl-text);
      margin-bottom: 0;
    }

    .control-group input,
    .control-group select {
      padding: 12px 16px;
      border: 2px solid var(--fpl-border);
      border-radius: var(--border-radius);
      background: var(--fpl-white);
      color: var(--fpl-text);
      font-size: 0.9rem;
      font-weight: 500;
      transition: var(--transition);
      outline: none;
      min-height: 44px;
    }

    .control-group input::placeholder {
      color: var(--fpl-text-light);
      font-weight: 400;
    }

    .control-group input:focus,
    .control-group select:focus {
      border-color: var(--fpl-primary);
      box-shadow: 0 0 0 3px rgba(55, 0, 60, 0.1);
    }

    .control-group select {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 12px center;
      background-repeat: no-repeat;
      background-size: 16px;
      padding-right: 40px;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
    }

    .control-group select option {
      padding: 12px 16px;
      background: var(--fpl-white);
      color: var(--fpl-text);
      font-size: 0.9rem;
      font-weight: 500;
      border: none;
      cursor: pointer;
    }

    .control-group select option:hover {
      background: var(--fpl-light-gray);
    }

    .control-group select option:checked {
      background: var(--fpl-primary);
      color: var(--fpl-white);
    }

    .btn {
      padding: 12px 24px;
      border: 2px solid var(--fpl-primary);
      border-radius: var(--border-radius-pill);
      font-weight: 600;
      font-size: 0.875rem;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      min-height: 44px;
      background: var(--fpl-white);
      color: var(--fpl-primary);
      text-decoration: none;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .btn:hover {
      background: var(--fpl-primary-light);
      color: var(--fpl-white);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .btn-primary {
      border-color: var(--fpl-primary);
      color: var(--fpl-primary);
      background: var(--fpl-white);
    }

    .btn-primary:hover {
      background: var(--fpl-primary-light);
      color: var(--fpl-white);
      border-color: var(--fpl-primary-light);
    }

    .btn-success {
      border-color: var(--fpl-success);
      color: var(--fpl-success);
      background: var(--fpl-white);
    }

    .btn-success:hover {
      background: var(--fpl-success);
      color: var(--fpl-white);
      border-color: var(--fpl-success);
    }

    .btn-danger {
      border-color: var(--fpl-danger);
      color: var(--fpl-danger);
      background: var(--fpl-white);
    }

    .btn-danger:hover {
      background: var(--fpl-danger);
      color: var(--fpl-white);
      border-color: var(--fpl-danger);
    }

    .template-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .fdr-key {
      background: var(--fpl-white);
      border: 1px solid var(--fpl-border);
      border-radius: var(--border-radius);
      padding: 12px 16px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }

    .fdr-key h3 {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--fpl-primary);
      margin-bottom: 8px;
    }

    .fdr-scale {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }

    .fdr-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
    }

    .fdr-button {
      width: 30px;
      height: 22px;
      border-radius: var(--border-radius-fdr);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.75rem;
      border: none;
    }

    .fdr-1-btn {
      background: var(--fdr-1);
      color: var(--fpl-white);
    }

    .fdr-2-btn {
      background: var(--fdr-2);
      color: var(--fpl-text);
    }

    .fdr-3-btn {
      background: var(--fdr-3);
      color: var(--fpl-text);
    }

    .fdr-4-btn {
      background: var(--fdr-4);
      color: var(--fpl-white);
    }

    .fdr-5-btn {
      background: var(--fdr-5);
      color: var(--fpl-white);
    }

    .fdr-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--fpl-primary);
    }

    .table-container {
      background: var(--fpl-white);
      border: 1px solid var(--fpl-border);
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: var(--shadow);
      overflow-x: auto;
      position: relative;
    }

    .fixture-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1200px;
      position: relative;
    }

    .fixture-table th {
      background: var(--fpl-white);
      color: var(--fpl-primary);
      font-weight: 600;
      padding: 8px 6px;
      text-align: center;
      border: 1px solid var(--fpl-border);
      font-size: 0.8rem;
      position: sticky;
      top: 0;
      z-index: 10;
      min-width: 80px;
    }

    .fixture-table th:first-child {
      position: sticky;
      left: 0;
      z-index: 30;
      background: var(--fpl-white);
      color: var(--fpl-text);
      border-right: 2px solid var(--fpl-border);
      min-width: 200px;
      box-shadow: 2px 0 4px rgba(0, 0, 0, 0.1);
    }

    .fixture-table th:first-child::before {
      content: "Starting 11";
      display: block;
      font-size: 0.75rem;
      font-weight: 400;
      color: var(--fpl-text-light);
      margin-bottom: 4px;
    }

    .fixture-table td {
      padding: 4px 6px;
      text-align: center;
      border: 1px solid var(--fpl-border);
      position: relative;
      transition: var(--transition);
      min-width: 80px;
    }

    .fixture-table td:first-child {
      position: sticky;
      left: 0;
      background: var(--fpl-white);
      color: var(--fpl-text);
      z-index: 20;
      border-right: 2px solid var(--fpl-border);
      font-weight: 600;
      min-width: 200px;
      box-shadow: 2px 0 4px rgba(0, 0, 0, 0.1);
    }

    /* Position color coding */
    .position-gk {
      background: #20B2AA !important;
      color: var(--fpl-white) !important;
    }

    .position-def {
      background: #FF8C00 !important;
      color: var(--fpl-white) !important;
    }

    .position-mid {
      background: #F5F5DC !important;
      color: var(--fpl-text) !important;
    }

    .position-fwd {
      background: #1E3A8A !important;
      color: var(--fpl-white) !important;
    }

    .fixture-table tr:hover td:first-child {
      background: var(--fpl-white);
    }

    .fixture-table tr:hover td:first-child.position-gk {
      background: #22B8B0 !important;
    }

    .fixture-table tr:hover td:first-child.position-def {
      background: #FFB74D !important;
    }

    .fixture-table tr:hover td:first-child.position-mid {
      background: #E6E6B8 !important;
    }

    .fixture-table tr:hover td:first-child.position-fwd {
      background: #3B5998 !important;
    }

    .fixture-table tr:nth-child(11) {
      border-bottom: 3px solid var(--fpl-primary);
      box-shadow: 0 2px 4px rgba(55, 0, 60, 0.2);
    }

    .fixture-table tr:nth-child(11) td {
      border-bottom: 3px solid var(--fpl-primary);
    }

    .fixture-table tr:nth-child(12) {
      border-top: 2px solid var(--fpl-border);
    }

    .fixture-table tr:nth-child(12) td {
      border-top: 2px solid var(--fpl-border);
    }

    .add-row-section {
      margin-top: 20px;
      text-align: center;
      padding: 20px;
      background: var(--fpl-white);
      border: 1px solid var(--fpl-border);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
    }

    .fixture-cell {
      font-size: 0.75rem;
      font-weight: 700;
      border-radius: var(--border-radius-fdr);
      padding: 3px 6px;
      margin: 1px;
      display: inline-block;
      min-width: 60px;
      text-align: center;
      box-shadow: var(--shadow);
      transition: var(--transition);
      white-space: nowrap;
      cursor: pointer;
    }

    .fixture-cell:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .fixture-cell.clicked {
      border: 2px solid var(--fpl-primary) !important;
    }

    .fixture-cell.hidden {
      opacity: 0.15 !important;
      background: rgba(255, 255, 255, 0.1) !important;
      border: 1px solid rgba(222, 226, 230, 0.3) !important;
      color: #6c757d !important;
      cursor: pointer;
    }

    .fdr-1 { 
      background: var(--fdr-1);
      color: var(--fpl-white);
    }
    .fdr-2 { 
      background: var(--fdr-2);
      color: var(--fpl-text);
    }
    .fdr-3 { 
      background: var(--fdr-3);
      color: var(--fpl-text);
    }
    .fdr-4 { 
      background: var(--fdr-4);
      color: var(--fpl-white);
    }
    .fdr-5 { 
      background: var(--fdr-5);
      color: var(--fpl-white);
    }

    .empty-cell {
      color: var(--fpl-text-light);
      font-style: italic;
      opacity: 0.6;
    }

    .loading {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--fpl-white);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: var(--border-radius);
      color: var(--fpl-white);
      font-weight: 600;
      z-index: 1000;
      transform: translateX(400px);
      transition: var(--transition);
      box-shadow: var(--shadow);
      background: var(--fpl-primary);
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background: var(--fpl-success);
    }

    .notification.error {
      background: var(--fpl-danger);
    }

    .notification.info {
      background: var(--fpl-primary);
    }

    .fixture-table tbody tr {
      cursor: grab;
      transition: var(--transition);
    }

    .fixture-table tbody tr:hover {
      background: var(--fpl-light-gray);
    }

    .fixture-table tbody tr.dragging {
      opacity: 0.5;
      cursor: grabbing;
      transform: rotate(2deg);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .fixture-table tbody tr.drag-over {
      border-top: 3px solid var(--fpl-primary);
      background: rgba(55, 0, 60, 0.1);
    }

    @media (max-width: 768px) {
      .controls-row {
        grid-template-columns: 1fr;
      }
      
      .controls-grid {
        grid-template-columns: 1fr;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .container {
        padding: 10px;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="welcome-header">
    <div class="header-content">
      <img src="logo.webp" alt="Liljans Logo" class="header-logo">
      <h1 class="welcome-text">LILJANS FPL FIXTURE PLANNER</h1>
    </div>
  </div>

  <!-- Side by side sections -->
  <div class="controls-row">
    <!-- Section 1: Fetch real team with team ID -->
    <div class="controls-section">
      <h3>Fetch Real FPL Team</h3>
      <div class="controls-grid">
        <div class="control-group">
          <label for="fplId">FPL Team ID</label>
          <input type="number" id="fplId" placeholder="Enter your FPL team ID" />
        </div>
      </div>
      <div class="template-buttons">
        <button class="btn" onclick="fetchFplTeam(event)" style="background: white; color: #1E3A8A; border-color: #1E3A8A;">
          <span>📥</span> Fetch Real Team
        </button>
      </div>
    </div>

    <!-- Section 2: Save new template and load old template -->
    <div class="controls-section">
      <h3>Template Management</h3>
      <div class="controls-grid">
        <div class="control-group">
          <label for="teamName">New Template Name</label>
          <input type="text" id="teamName" placeholder="Enter template name" />
        </div>
        <div class="control-group">
          <label for="savedTeams">Load Saved Templates</label>
          <select id="savedTeams" class="player-select" onchange="loadTeam()">
            <option value="">Select a saved template...</option>
          </select>
        </div>
      </div>
      <div class="template-buttons">
        <button class="btn" onclick="saveTeam()" style="background: white; color: #20B2AA; border-color: #20B2AA;">
          <span>💾</span> Save Template
        </button>
        <button class="btn" onclick="deleteTeam()" style="background: white; color: #FF8C00; border-color: #FF8C00;">
          <span>🗑️</span> Delete Template
        </button>
      </div>
    </div>
  </div>

  <!-- FDR Key -->
  <div class="fdr-key">
    <div class="fdr-scale">
      <span style="font-size: 0.75rem; font-weight: 600; color: var(--fpl-primary);">Fixture difficulty: Easy</span>
      <div class="fdr-button fdr-1-btn">1</div>
      <span style="font-size: 0.75rem; color: var(--fpl-text-light);">-</span>
      <div class="fdr-button fdr-2-btn">2</div>
      <span style="font-size: 0.75rem; color: var(--fpl-text-light);">-</span>
      <div class="fdr-button fdr-3-btn">3</div>
      <span style="font-size: 0.75rem; color: var(--fpl-text-light);">-</span>
      <div class="fdr-button fdr-4-btn">4</div>
      <span style="font-size: 0.75rem; color: var(--fpl-text-light);">-</span>
      <div class="fdr-button fdr-5-btn">5</div>
      <span style="font-size: 0.75rem; font-weight: 600; color: var(--fpl-primary);">Hard</span>
    </div>
</div>

  <div class="table-container">
    <table class="fixture-table" id="fixtureTable">
      <thead>
        <tr>
          <th>Squad</th>
        </tr>
      </thead>
    <tbody>
      {% for i in range(num_rows) %}
        <tr draggable="true">
        <td>
            <select class="player-select" onchange="updateRow(this, {{ i }})">
            <option value="">-- Select Player --</option>
          </select>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>

  <div class="add-row-section">
    <button class="btn" onclick="addNewRow()" style="background: white; color: #20B2AA; border-color: #20B2AA;">
      <span>➕</span> Add Player Row
    </button>
    <button class="btn" onclick="removeLastRow()" style="background: white; color: #FF8C00; border-color: #FF8C00;">
      <span>➖</span> Remove Last Row
    </button>
  </div>
</div>

<script>
let players = {{ players_json | safe }};
let fixtures = {{ fixtures_json | safe }};
let selectedPlayers = Array({{ num_rows }}).fill(null);
let starting11Players = new Set();

function showNotification(message, type = 'success') {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => notification.classList.add('show'), 100);
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => document.body.removeChild(notification), 300);
  }, 3000);
}

function toggleStarting11(checkbox, rowIndex) {
  if (checkbox.checked) {
    starting11Players.add(rowIndex);
    movePlayerToTop(rowIndex);
  } else {
    starting11Players.delete(rowIndex);
    renderTable();
  }
}

function movePlayerToTop(checkedRowIndex) {
  const playerId = selectedPlayers[checkedRowIndex];
  if (!playerId) return;
  
  const player = players.find(p => p.id == playerId);
  if (!player) return;
  
  // Get all starting 11 players with their positions
  const starting11Data = [];
  starting11Players.forEach(rowIndex => {
    const playerId = selectedPlayers[rowIndex];
    if (playerId) {
      const player = players.find(p => p.id == playerId);
      if (player) {
        starting11Data.push({
          rowIndex: rowIndex,
          playerId: playerId,
          position: player.position
        });
      }
    }
  });
  
  // Sort by position: GK (1), DEF (2), MID (3), FWD (4)
  starting11Data.sort((a, b) => a.position - b.position);
  
  // Reorder the selectedPlayers array based on sorted positions
  const newSelectedPlayers = [...selectedPlayers];
  const nonStartingPlayers = [];
  
  // Separate starting 11 and non-starting players
  for (let i = 0; i < selectedPlayers.length; i++) {
    if (!starting11Players.has(i)) {
      nonStartingPlayers.push(selectedPlayers[i]);
    }
  }
  
  // Put sorted starting 11 first, then non-starting players
  let currentIndex = 0;
  starting11Data.forEach(item => {
    newSelectedPlayers[currentIndex] = item.playerId;
    currentIndex++;
  });
  
  nonStartingPlayers.forEach(playerId => {
    newSelectedPlayers[currentIndex] = playerId;
    currentIndex++;
  });
  
  selectedPlayers = newSelectedPlayers;
  
  // Reorder the DOM rows to match the new player order
  const tbody = document.querySelector("#fixtureTable tbody");
  const rows = Array.from(tbody.querySelectorAll("tr"));
  
  // Create a map of player IDs to their new positions
  const playerToNewPosition = {};
  newSelectedPlayers.forEach((playerId, newIndex) => {
    if (playerId) {
      playerToNewPosition[playerId] = newIndex;
    }
  });
  
  // Sort rows based on their player's new position
  rows.sort((rowA, rowB) => {
    const selectA = rowA.querySelector("select");
    const selectB = rowB.querySelector("select");
    const playerIdA = parseInt(selectA.value) || 0;
    const playerIdB = parseInt(selectB.value) || 0;
    
    const positionA = playerToNewPosition[playerIdA] ?? 999;
    const positionB = playerToNewPosition[playerIdB] ?? 999;
    
    return positionA - positionB;
  });
  
  // Reorder the DOM
  rows.forEach(row => {
    tbody.appendChild(row);
  });
  
  // Update checkboxes to reflect new positions
  setTimeout(() => {
    const checkboxes = document.querySelectorAll('.player-checkbox');
    checkboxes.forEach((checkbox, index) => {
      checkbox.checked = starting11Players.has(index);
    });
  }, 100);
}

window.onload = () => {
  const selects = document.querySelectorAll(".player-select");
  selects.forEach(select => {
    players.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.text = p.web_name + " (" + p.team_name + ")";
      select.appendChild(opt);
    });
  });
  renderTable();
  populateSavedTeams();
  initializeDragAndDrop();
};

function renderTable() {
  const headerRow = document.querySelector("#fixtureTable thead tr");
  headerRow.innerHTML = "<th>Squad</th>";
  
  // Always show all 38 gameweeks
  for (let gw = 1; gw <= 38; gw++) {
    const th = document.createElement("th");
    th.innerText = "GW " + gw;
    headerRow.appendChild(th);
  }

  const rows = document.querySelectorAll("#fixtureTable tbody tr");
  rows.forEach((row, i) => {
    const playerId = selectedPlayers[i];
    row.querySelector("select").value = playerId || "";
    while (row.cells.length > 1) row.deleteCell(-1);
    
    if (!playerId) return;
    
    const player = players.find(p => p.id == playerId);
    const teamFixtures = fixtures[player.team_id] || [];
    
    // Apply position-based color coding to the player cell
    const playerCell = row.querySelector("td:first-child");
    playerCell.className = ""; // Clear existing classes
    if (player.position === 1) {
      playerCell.classList.add("position-gk");
    } else if (player.position === 2) {
      playerCell.classList.add("position-def");
    } else if (player.position === 3) {
      playerCell.classList.add("position-mid");
    } else if (player.position === 4) {
      playerCell.classList.add("position-fwd");
    }
    
    for (let gw = 1; gw <= 38; gw++) {
      const cell = document.createElement("td");
      const match = teamFixtures.find(f => f.event === gw);
      
      if (match) {
        const fixtureDiv = document.createElement("div");
        fixtureDiv.className = `fixture-cell fdr-${match.difficulty}`;
        fixtureDiv.textContent = `${match.opponent} (${match.location})`;
        fixtureDiv.onclick = function() {
          toggleFixtureVisibility(this, i, gw, row);
        };
        cell.appendChild(fixtureDiv);
      } else {
        cell.innerHTML = '<span class="empty-cell">-</span>';
      }
      row.appendChild(cell);
    }
  });
}

function toggleFixtureVisibility(fixtureCell, rowIndex, gameweek, row) {
  const isStarting11 = rowIndex < 11;
  const isClicked = fixtureCell.classList.contains('clicked');
  
  // Toggle clicked state
  if (isClicked) {
    fixtureCell.classList.remove('clicked');
    showAllFixtures(row);
  } else {
    fixtureCell.classList.add('clicked');
    
    if (isStarting11) {
      // Starting 11: Hide future gameweeks
      hideFutureFixtures(row, gameweek);
    } else {
      // Bench: Hide past gameweeks
      hidePastFixtures(row, gameweek);
    }
  }
}

function hideFutureFixtures(row, gameweek) {
  const fixtureCells = row.querySelectorAll('.fixture-cell');
  fixtureCells.forEach((cell, index) => {
    const cellGameweek = index + 1;
    if (cellGameweek > gameweek) {
      cell.classList.add('hidden');
    }
  });
}

function hidePastFixtures(row, gameweek) {
  const fixtureCells = row.querySelectorAll('.fixture-cell');
  fixtureCells.forEach((cell, index) => {
    const cellGameweek = index + 1;
    if (cellGameweek < gameweek) {
      cell.classList.add('hidden');
    }
  });
}

function showAllFixtures(row) {
  const fixtureCells = row.querySelectorAll('.fixture-cell');
  fixtureCells.forEach(cell => {
    cell.classList.remove('hidden');
  });
}

function updateRow(select, rowIndex) {
  // Find the actual row index in the DOM
  const rows = Array.from(document.querySelectorAll("#fixtureTable tbody tr"));
  const actualRowIndex = rows.indexOf(select.closest("tr"));
  
  // Update the player in the correct position
  selectedPlayers[actualRowIndex] = parseInt(select.value);
  renderTable();
}

function saveTeam() {
  const name = document.getElementById("teamName").value.trim();
  const loadedTemplate = document.getElementById("savedTeams").value;
  
  // If no name is entered but a template is loaded, update the loaded template
  if (!name && loadedTemplate) {
    localStorage.setItem("fpl_team_" + loadedTemplate, JSON.stringify(selectedPlayers));
    populateSavedTeams();
    return;
  }
  
  // If no name is entered and no template is loaded, don't save
  if (!name) {
    return;
  }
  
  localStorage.setItem("fpl_team_" + name, JSON.stringify(selectedPlayers));
  populateSavedTeams();
}

function loadTeam() {
  const name = document.getElementById("savedTeams").value;
  const saved = localStorage.getItem("fpl_team_" + name);
  
  if (!saved) {
    return;
  }
  
  selectedPlayers = JSON.parse(saved);
  renderTable();
}

function deleteTeam() {
  const name = document.getElementById("savedTeams").value;
  if (!name) {
    return;
  }
  
  localStorage.removeItem("fpl_team_" + name);
  populateSavedTeams();
}

function populateSavedTeams() {
  const dropdown = document.getElementById("savedTeams");
  dropdown.innerHTML = '<option value="">Select a saved template...</option>';
  
  for (let key in localStorage) {
    if (key.startsWith("fpl_team_")) {
      const opt = document.createElement("option");
      opt.value = key.slice(9);
      opt.text = key.slice(9);
      dropdown.appendChild(opt);
    }
  }
}

// Drag and Drop functionality
function initializeDragAndDrop() {
  const tbody = document.querySelector("#fixtureTable tbody");
  let draggedRow = null;

  tbody.addEventListener("dragstart", function(e) {
    if (e.target.closest("tr")) {
      draggedRow = e.target.closest("tr");
      draggedRow.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
      e.dataTransfer.setData("text/html", draggedRow.outerHTML);
    }
  });

  tbody.addEventListener("dragend", function(e) {
    if (draggedRow) {
      draggedRow.classList.remove("dragging");
      draggedRow = null;
    }
  });

  tbody.addEventListener("dragover", function(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = "move";
    
    const targetRow = e.target.closest("tr");
    if (targetRow && targetRow !== draggedRow) {
      // Remove existing drag-over classes
      tbody.querySelectorAll("tr").forEach(tr => tr.classList.remove("drag-over"));
      targetRow.classList.add("drag-over");
    }
  });

  tbody.addEventListener("dragleave", function(e) {
    const targetRow = e.target.closest("tr");
    if (targetRow) {
      targetRow.classList.remove("drag-over");
    }
  });

  tbody.addEventListener("drop", function(e) {
    e.preventDefault();
    
    const targetRow = e.target.closest("tr");
    if (targetRow && draggedRow && targetRow !== draggedRow) {
      // Get the row indices
      const rows = Array.from(tbody.querySelectorAll("tr"));
      const draggedIndex = rows.indexOf(draggedRow);
      const targetIndex = rows.indexOf(targetRow);
      
      // Reorder the selectedPlayers array
      const draggedPlayer = selectedPlayers[draggedIndex];
      selectedPlayers.splice(draggedIndex, 1);
      selectedPlayers.splice(targetIndex, 0, draggedPlayer);
      
      // Reorder the DOM
      if (draggedIndex < targetIndex) {
        targetRow.parentNode.insertBefore(draggedRow, targetRow.nextSibling);
      } else {
        targetRow.parentNode.insertBefore(draggedRow, targetRow);
      }
      
      // Update the table without re-rendering to preserve fixture states
      updateTableAfterReorder();
    }
    
    // Remove drag-over classes
    tbody.querySelectorAll("tr").forEach(tr => tr.classList.remove("drag-over"));
  });
}

function updateTableAfterReorder() {
  // Update the selectedPlayers array to match the new DOM order
  const rows = document.querySelectorAll("#fixtureTable tbody tr");
  const newSelectedPlayers = [];
  
  rows.forEach((row, index) => {
    const select = row.querySelector("select");
    const playerId = parseInt(select.value) || null;
    newSelectedPlayers[index] = playerId;
  });
  
  selectedPlayers = newSelectedPlayers;
  
  // Update checkboxes to reflect new positions
  setTimeout(() => {
    const checkboxes = document.querySelectorAll('.player-checkbox');
    checkboxes.forEach((checkbox, index) => {
      checkbox.checked = starting11Players.has(index);
    });
  }, 100);
}

async function fetchFplTeam(event) {
  const id = document.getElementById("fplId").value.trim();
  if (!id) {
    return;
  }
  
  const loadBtn = event.target;
  const originalText = loadBtn.innerHTML;
  loadBtn.innerHTML = '<span class="loading"></span> Loading...';
  loadBtn.disabled = true;
  
  try {
    const res = await fetch(`https://fantasy.premierleague.com/api/entry/${id}/event/1/picks/`);
    if (!res.ok) throw new Error("Not available yet. GW1 might not have started.");
    
    const data = await res.json();
    const picks = data.picks.map(p => p.element);
    
    if (picks.length > 0) {
      selectedPlayers = picks.slice(0, {{ num_rows }});
      renderTable();
    }
  } catch (e) {
    // Silent error handling
  } finally {
    loadBtn.innerHTML = originalText;
    loadBtn.disabled = false;
  }
}

function addNewRow() {
  const tbody = document.querySelector("#fixtureTable tbody");
  const newRow = document.createElement("tr");
  newRow.draggable = "true";
  
  const td = document.createElement("td");
  
  const playerSelect = document.createElement("select");
  playerSelect.className = "player-select";
  playerSelect.onchange = function() {
    updateRow(this, tbody.children.length - 1);
  };
  
  // Add default option
  const defaultOpt = document.createElement("option");
  defaultOpt.value = "";
  defaultOpt.text = "-- Select Player --";
  playerSelect.appendChild(defaultOpt);
  
  // Add all player options
  players.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p.id;
    opt.text = p.web_name + " (" + p.team_name + ")";
    playerSelect.appendChild(opt);
  });
  
  td.appendChild(playerSelect);
  newRow.appendChild(td);
  tbody.appendChild(newRow);
  
  // Add to selectedPlayers array
  selectedPlayers.push(null);
  
  renderTable();
}

function removeLastRow() {
  const tbody = document.querySelector("#fixtureTable tbody");
  const lastRow = tbody.lastElementChild;
  if (lastRow) {
    tbody.removeChild(lastRow);
    selectedPlayers.pop(); // Remove the last player from the array
    renderTable();
  }
}
</script>

</body>
</html>
